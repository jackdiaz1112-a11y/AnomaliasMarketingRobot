      - name: Publish to Bluesky
        if: always()
        env:
          BLUESKY_USERNAME: ${{ secrets.BLUESKY_USERNAME }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
        run: |
          pip install atproto
          python3 - <<'PY'
import os
from atproto import Client
from atproto.models import AppBskyFeedPost, AppBskyEmbedImages

handle = os.environ.get("BLUESKY_USERNAME")
app_password = os.environ.get("BLUESKY_PASSWORD")

if not handle or not app_password:
    print("No Bluesky credentials configured. Skipping publish.")
    exit(0)

text_path = "last_post_for_bluesky.txt"
imgref_path = "last_post_image.txt"

if not os.path.exists(text_path):
    print("No text for Bluesky, skipping.")
    exit(0)

text = open(text_path, "r", encoding="utf-8").read().strip()

img_path = None
if os.path.exists(imgref_path):
    v = open(imgref_path, "r", encoding="utf-8").read().strip()
    if v:
        img_path = v

client = Client()
client.login(handle, app_password)
print("Logged in:", client.me.did)

image_blob_ref = None
if img_path and os.path.exists(img_path):
    with open(img_path, "rb") as f:
        b = f.read()
    uploaded = client.com.atproto.repo.upload_blob(b, "image/png")
    image_blob_ref = uploaded.blob

images_embed = None
if image_blob_ref:
    images_embed = AppBskyEmbedImages.Main(
        images=[
            AppBskyEmbedImages.Image(
                image=image_blob_ref,
                alt="Imagen generada por el robot"
            )
        ]
    )

record = AppBskyFeedPost.Record(text=text, embed=images_embed)
resp = client.app.bsky.feed.post.create(
    repo=client.me.did,
    record=record
)

print("Post created:", resp)
PY
