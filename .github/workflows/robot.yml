name: Ejecutar Robot Anomalias
permissions:
  contents: write

on:
  schedule:
    - cron: "0 13 * * *"
  workflow_dispatch:

jobs:
  run-robot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas gspread oauth2client gspread_dataframe db-dtypes google-api-python-client openpyxl atproto

      - name: Run robot script
        env:
          API_KEY: ${{ secrets.API_KEY }}
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
          BEACONS_URL: ${{ secrets.BEACONS_URL }}
        run: |
          python robot.py

      - name: Save result artifacts
        run: |
          echo "Guardando resultados..."
          cp output_text.txt last_post_for_bluesky.txt || true
          cp output_image.jpg last_post_image.jpg || true

      - name: Auto-commit results
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Resultados automáticos del robot – build ${{ github.run_id }}"

      - name: Publish to Bluesky
        if: always()
        env:
          BLUESKY_USERNAME: ${{ secrets.BLUESKY_USERNAME }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
        run: |
          python3 - <<'PY'
import os
from atproto import Client
from atproto.models.app.bsky.embed.images import Main as ImageEmbed, Image as ImageItem
from atproto.models.app.bsky.feed.post import Main as Post

handle = os.environ.get("BLUESKY_USERNAME")
app_password = os.environ.get("BLUESKY_PASSWORD")

if not handle or not app_password:
    print("No Bluesky credentials configured. Skipping publish.")
    exit(0)

text_path = "last_post_for_bluesky.txt"
img_path = "last_post_image.jpg"

if not os.path.exists(text_path):
    print("No text file to publish. Skipping.")
    exit(0)

with open(text_path, "r", encoding="utf-8") as f:
    text = f.read().strip()

client = Client()
client.login(handle, app_password)

if os.path.exists(img_path):
    with open(img_path, "rb") as img_file:
        uploaded = client.upload_blob(img_file.read())
    embed = ImageEmbed(images=[ImageItem(alt="Robot Image", image=uploaded.blob)])
    post = Post(text=text, embed=embed)
else:
    post = Post(text=text)

client.send_post(post)
print("Bluesky post published successfully.")
PY
